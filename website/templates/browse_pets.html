{% extends "base.html" %}
{% block title %}Browse Pets{% endblock %}
{% block content %}
<div class="browse-pets-container">

  <!-- Combined Search and Filter Row -->
  <div class="d-flex align-items-center mb-4 w-100" style="gap: 0;">
    <!-- Search bar with clear button -->
    <div class="search-wrapper d-flex align-items-center gap-2" style="width: 80%;">
      <input type="text" id="searchInput" class="form-control search-input" placeholder="Search for pets..."
        onkeyup="searchPets()">
      <button id="clearSearch" class="btn btn-outline-secondary" style="display: none;"
        onclick="clearSearch()">âœ•</button>
    </div>

    <!-- Unified Filter Button -->
    <div class="filter-wrapper mb-4 px-3">
      <div class="dropdown" style="width: 20%;">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="filterDropdown"
          data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-funnel-fill"></i>
        </button>
        <div class="dropdown-menu p-3" style="min-width: 250px;">
          <strong class="dropdown-header">Filter by Group</strong>
          <a class="dropdown-item" href="#" onclick="filterByGroup('All')">All</a>
          {% for group in animal_groups.keys() %}
          <a class="dropdown-item" href="#" onclick="filterByGroup('{{ group }}')">{{ group }}</a>
          {% endfor %}

          <div class="dropdown-divider"></div>
          <strong class="dropdown-header">Sort by Age</strong>
          <a class="dropdown-item" href="#" onclick="sortPets('age', 'asc')">Youngest First</a>
          <a class="dropdown-item" href="#" onclick="sortPets('age', 'desc')">Oldest First</a>

          <div class="dropdown-divider"></div>
          <strong class="dropdown-header">Sort by Breed</strong>
          <a class="dropdown-item" href="#" onclick="sortPets('breed', 'asc')">A to Z</a>
          <a class="dropdown-item" href="#" onclick="sortPets('breed', 'desc')">Z to A</a>
        </div>
      </div>
    </div>
  </div>

  <h2>Need a new friend? You've come to the right place</h2>
  <div class="container mt-4 petGroupsContainer">
    {% for group, animals in animal_groups.items() %}
    <h3 class="mb-3 group">{{ group }}</h3>
    <div class="pet-group" id="group-{{ group }}">
      {% for animal in animals %}
      <div class="pet-card-wrapper" data-name="{{ animal.name }}" data-breed="{{ animal.breed }}"
        data-age="{{ animal.age }}">
        <div class="card pet-card h-100" style="border-radius: 1rem; overflow: hidden;">
          <img src="{{ url_for('static', filename='images/' + animal.image) }}" class="card-img-top"
            alt="{{ animal.name }}">
          <div class="card-body d-flex flex-column justify-content-between">
            <div>
              <h5 class="card-title mb-1">{{ animal.name }}</h5>
              <p class="card-breed mb-1 text-muted">Breed: {{ animal.breed }}</p>
              <p class="card-age mb-2 text-muted">Age: {{ animal.age }} years old</p>
            </div>
            <a href="{{ url_for('views.adopt', animal_id=animal.id) }}"
              class="btn btn-primary btn-sm mt-auto adopt-btn">Adopt</a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endfor %}
  </div>
  <div id="noResultsMessage" class="text-center text-muted my-4" style="display: none;">
    <h5>No pets found matching your search.</h5>
  </div>


</div>

<!-- JavaScript for searching and clearing -->
<script>
  function searchPets() {
    const searchInput = document.getElementById('searchInput').value.toLowerCase();
    const clearSearchButton = document.getElementById('clearSearch');
    const noResultsMessage = document.getElementById('noResultsMessage');
    const petGroupsContainer = document.querySelector('.petGroupsContainer');

    // Show the "clear" button if there's text in the search bar
    clearSearchButton.style.display = searchInput.length > 0 ? 'block' : 'none';

    const groups = document.querySelectorAll('.pet-group');
    let anyVisible = false;

    groups.forEach(group => {
      const cards = Array.from(group.getElementsByClassName('pet-card-wrapper'));

      const filteredCards = cards.filter(card => {
        const name = card.getAttribute('data-name').toLowerCase();
        const breed = card.getAttribute('data-breed').toLowerCase();
        const age = card.getAttribute('data-age').toLowerCase();

        return name.includes(searchInput) || breed.includes(searchInput) || age.includes(searchInput);
      });

      // Hide all cards first
      cards.forEach(card => {
        card.style.display = 'none';
      });

      // Show matching cards
      filteredCards.forEach(card => {
        card.style.display = 'block';
      });

      // If this group has any visible cards, mark the flag
      if (filteredCards.length > 0) {
        anyVisible = true;
      }
    });

    // Toggle the visibility of the "No results" message
    if (anyVisible) {
      petGroupsContainer.style.display = 'block';
      noResultsMessage.style.display = 'none';
    } else {
      petGroupsContainer.style.display = 'none'; // Hide the groups if no pets match
      noResultsMessage.style.display = 'block'; // Show the "No pets found" message
    }
  }

  function clearSearch() {
    // Clear the search input and hide the "clear" button
    document.getElementById('searchInput').value = '';
    document.getElementById('clearSearch').style.display = 'none';

    // Get all pet groups and reset them
    const groups = document.querySelectorAll('.pet-group');

    groups.forEach(group => {
      const cards = Array.from(group.getElementsByClassName('pet-card-wrapper'));

      // Show all cards and reset visibility
      cards.forEach(card => {
        card.style.display = 'block';
      });
    });

    // Show the pet groups and hide the "No results" message
    document.querySelector('.petGroupsContainer').style.display = 'block';
    document.getElementById('noResultsMessage').style.display = 'none';
  }

</script>

<script>
  // Current group filter state
  let activeGroup = 'All';

  function filterByGroup(group) {
    activeGroup = group;
    applyFilters();
  }

  function sortPets(key, order) {
    const petGroups = document.querySelectorAll('.pet-group');

    petGroups.forEach(group => {
      const cards = Array.from(group.getElementsByClassName('pet-card-wrapper'));

      const sorted = cards.sort((a, b) => {
        let aVal = a.dataset[key].toLowerCase();
        let bVal = b.dataset[key].toLowerCase();

        // Convert age to number for numeric sorting
        if (key === 'age') {
          aVal = parseInt(aVal);
          bVal = parseInt(bVal);
        }

        if (aVal < bVal) return order === 'asc' ? -1 : 1;
        if (aVal > bVal) return order === 'asc' ? 1 : -1;
        return 0;
      });

      // Re-append sorted cards
      const container = group;
      sorted.forEach(card => container.appendChild(card));
    });
  }

  function applyFilters() {
    const searchInput = document.getElementById('searchInput').value.toLowerCase();
    const petGroups = document.querySelectorAll('.pet-group');
    const allGroups = document.querySelectorAll('.group');
    const noResultsMessage = document.getElementById('noResultsMessage');

    let anyVisible = false;

    petGroups.forEach((group, index) => {
      const groupName = allGroups[index].textContent.trim();
      const showGroup = activeGroup === 'All' || groupName === activeGroup;

      const cards = Array.from(group.getElementsByClassName('pet-card-wrapper'));

      let groupVisible = false;

      cards.forEach(card => {
        const name = card.dataset.name.toLowerCase();
        const breed = card.dataset.breed.toLowerCase();
        const age = card.dataset.age.toLowerCase();
        const matchesSearch = name.includes(searchInput) || breed.includes(searchInput) || age.includes(searchInput);

        const visible = showGroup && matchesSearch;
        card.style.display = visible ? 'block' : 'none';
        if (visible) groupVisible = true;
      });

      // Show or hide group heading and container
      group.style.display = groupVisible ? 'flex' : 'none';
      allGroups[index].style.display = groupVisible ? 'block' : 'none';

      if (groupVisible) anyVisible = true;
    });

    document.querySelector('.petGroupsContainer').style.display = anyVisible ? 'block' : 'none';
    noResultsMessage.style.display = anyVisible ? 'none' : 'block';
  }

  // Hook into search as well
  document.getElementById('searchInput').addEventListener('input', applyFilters);

  function clearSearch() {
    document.getElementById('searchInput').value = '';
    document.getElementById('clearSearch').style.display = 'none';
    applyFilters();
  }

  // Show/hide clear button on typing
  document.getElementById('searchInput').addEventListener('keyup', function () {
    document.getElementById('clearSearch').style.display = this.value ? 'block' : 'none';
  });
</script>




{% endblock %}